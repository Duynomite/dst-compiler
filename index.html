<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DST Compiler Tool — Clear Path Coverage</title>
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500;600;700&family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style type="text/tailwindcss">
    @theme {
      --color-accent: #3DCEB2;
      --color-accent-dark: #2BA891;
      --color-secondary: #2D5A7A;
      --color-secondary-light: #3B6F94;
      --color-text: #34252F;
      --color-deep-navy: #10202C;
      --color-light-cyan: #D8E6E3;
      --color-mid-blue: #4B7797;
      --color-soft-blue: #A7B8C5;
      --font-heading: "Urbanist", sans-serif;
      --font-body: "Jost", sans-serif;
    }
  </style>
  <style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes copiedPop { 0% { opacity: 0; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0; transform: scale(1); } }
    @keyframes urgentPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .copied-anim { animation: copiedPop 1.2s ease-out forwards; }
    .pulse-urgent { animation: urgentPulse 2s ease-in-out infinite; }
    .autocomplete-list { max-height: 200px; overflow-y: auto; }
    .autocomplete-item:hover { background-color: #D8E6E3; }
    .dst-card { transition: box-shadow 0.2s ease, transform 0.2s ease; }
    .dst-card:hover { box-shadow: 0 4px 16px rgba(45, 90, 122, 0.10); transform: translateY(-1px); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-body text-text">
  <div id="root"></div>
  <noscript>
    <div style="max-width:600px;margin:60px auto;padding:32px;text-align:center;font-family:sans-serif;">
      <h1 style="font-size:24px;margin-bottom:12px;">DST Compiler Tool</h1>
      <p style="font-size:16px;color:#666;margin-bottom:20px;">
        This tool requires JavaScript to run. Please enable JavaScript in your browser, or try a different browser.
      </p>
      <p style="font-size:14px;color:#999;">
        If the tool still doesn't load, CDN dependencies (React, Tailwind) may be temporarily unavailable. Try refreshing in a few minutes.
      </p>
    </div>
  </noscript>

  <script type="text/babel" data-type="module">
    // =========================================================================
    // DST Compiler Tool v2.0 — CPC Brand
    // =========================================================================

    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // =========================================================================
    // Constants
    // =========================================================================

    const FEMA_API_BASE = 'https://www.fema.gov/api/open/v2/DisasterDeclarationsSummaries';
    const FEMA_PAGE_SIZE = 1000;
    const STALENESS_DAYS = 7; // Show warning if curated data is older than this

    // Source badge colors
    const SOURCE_COLORS = {
      FEMA:  { bg: '#3B82F6', text: '#FFFFFF', label: 'FEMA' },
      HHS:   { bg: '#EF4444', text: '#FFFFFF', label: 'HHS' },
      SBA:   { bg: '#F97316', text: '#FFFFFF', label: 'SBA' },
      USDA:  { bg: '#92400E', text: '#FFFFFF', label: 'USDA' },
      FMCSA: { bg: '#A855F7', text: '#FFFFFF', label: 'FMCSA' },
      STATE: { bg: '#22C55E', text: '#FFFFFF', label: 'GOV' },
    };

    // US State names for display
    const STATE_NAMES = {
      AL:'Alabama',AK:'Alaska',AZ:'Arizona',AR:'Arkansas',CA:'California',
      CO:'Colorado',CT:'Connecticut',DE:'Delaware',DC:'District of Columbia',
      FL:'Florida',GA:'Georgia',GU:'Guam',HI:'Hawaii',ID:'Idaho',IL:'Illinois',
      IN:'Indiana',IA:'Iowa',KS:'Kansas',KY:'Kentucky',LA:'Louisiana',
      ME:'Maine',MD:'Maryland',MA:'Massachusetts',MI:'Michigan',MN:'Minnesota',
      MS:'Mississippi',MO:'Missouri',MT:'Montana',NE:'Nebraska',NV:'Nevada',
      NH:'New Hampshire',NJ:'New Jersey',NM:'New Mexico',NY:'New York',
      NC:'North Carolina',ND:'North Dakota',MP:'Northern Mariana Islands',
      OH:'Ohio',OK:'Oklahoma',OR:'Oregon',PA:'Pennsylvania',PR:'Puerto Rico',
      RI:'Rhode Island',SC:'South Carolina',SD:'South Dakota',TN:'Tennessee',
      TX:'Texas',UT:'Utah',VT:'Vermont',VA:'Virginia',VI:'Virgin Islands',
      WA:'Washington',WV:'West Virginia',WI:'Wisconsin',WY:'Wyoming',
      AS:'American Samoa'
    };

    // =========================================================================
    // SEP Window Calculation — 42 CFR § 422.62(b)(18)
    // CRITICAL: "2 full calendar months" is NOT "60 days"
    // DO NOT use Date.setMonth() — it overflows on end-of-month dates
    // =========================================================================

    function calculateSEPWindowEnd(incidentEnd) {
      if (!incidentEnd) return null;
      const d = new Date(incidentEnd + 'T00:00:00');
      const month = d.getMonth();
      const year = d.getFullYear();
      let targetMonth = month + 2;
      let targetYear = year;
      if (targetMonth > 11) {
        targetMonth -= 12;
        targetYear += 1;
      }
      return new Date(targetYear, targetMonth + 1, 0);
    }

    function calculateOngoingMaxEnd(sepStart, renewalDates) {
      let maxDate = new Date(sepStart + 'T00:00:00');
      if (renewalDates && renewalDates.length > 0) {
        for (const rd of renewalDates) {
          const rDate = new Date(rd + 'T00:00:00');
          if (rDate > maxDate) maxDate = rDate;
        }
      }
      const month = maxDate.getMonth();
      const year = maxDate.getFullYear();
      let targetMonth = month + 14;
      let targetYear = year;
      while (targetMonth > 11) {
        targetMonth -= 12;
        targetYear += 1;
      }
      return new Date(targetYear, targetMonth + 1, 0);
    }

    function calculateSEPStart(declarationDate, incidentStart) {
      const decl = new Date(declarationDate + 'T00:00:00');
      const inc = new Date(incidentStart + 'T00:00:00');
      return decl < inc ? decl : inc;
    }

    function calculateStatus(sepEnd, isOngoing) {
      if (!sepEnd) return 'ongoing';
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const diffMs = sepEnd.getTime() - today.getTime();
      const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
      if (diffDays < 0) return 'expired';
      if (diffDays <= 30) return 'expiring_soon';
      if (isOngoing) return 'ongoing';
      return 'active';
    }

    function getDaysRemaining(sepEnd) {
      if (!sepEnd) return null;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const diffMs = sepEnd.getTime() - today.getTime();
      return Math.ceil(diffMs / (1000 * 60 * 60 * 24));
    }

    // =========================================================================
    // Date formatting
    // =========================================================================

    function formatDateHuman(dateStr) {
      if (!dateStr) return 'Ongoing';
      const d = new Date(dateStr + 'T00:00:00');
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
    }

    function formatDateFromObj(dateObj) {
      if (!dateObj) return 'Ongoing';
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return `${months[dateObj.getMonth()]} ${dateObj.getDate()}, ${dateObj.getFullYear()}`;
    }

    function toISODate(dateObj) {
      if (!dateObj) return null;
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, '0');
      const d = String(dateObj.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    // =========================================================================
    // FEMA API Fetching with Pagination
    // =========================================================================

    async function fetchAllFEMA() {
      const cutoffDate = new Date();
      cutoffDate.setMonth(cutoffDate.getMonth() - 24);
      const cutoffStr = cutoffDate.toISOString().split('T')[0];

      let allRecords = [];
      let skip = 0;
      let hasMore = true;

      while (hasMore) {
        const filterParam = `declarationDate ge '${cutoffStr}'`;
        const url = `${FEMA_API_BASE}?$filter=${encodeURIComponent(filterParam)}&$orderby=${encodeURIComponent('declarationDate desc')}&$top=${FEMA_PAGE_SIZE}&$skip=${skip}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error(`FEMA API returned ${response.status}`);

        const data = await response.json();
        const records = data.DisasterDeclarationsSummaries || [];
        allRecords = allRecords.concat(records);

        if (records.length < FEMA_PAGE_SIZE) {
          hasMore = false;
        } else {
          skip += FEMA_PAGE_SIZE;
        }
      }

      return allRecords;
    }

    // =========================================================================
    // FEMA Record Consolidation
    // =========================================================================

    function consolidateFEMA(records) {
      const validRecords = records.filter(r => r.declarationType !== 'FM');

      const groups = {};
      for (const rec of validRecords) {
        const key = rec.femaDeclarationString;
        if (!groups[key]) {
          groups[key] = {
            femaDeclarationString: key,
            declarationType: rec.declarationType,
            declarationDate: rec.declarationDate ? rec.declarationDate.split('T')[0] : null,
            incidentBeginDate: rec.incidentBeginDate ? rec.incidentBeginDate.split('T')[0] : null,
            incidentEndDate: rec.incidentEndDate ? rec.incidentEndDate.split('T')[0] : null,
            state: rec.state,
            declarationTitle: rec.declarationTitle,
            incidentType: rec.incidentType,
            disasterNumber: rec.disasterNumber,
            counties: [],
          };
        }
        const county = rec.designatedArea
          ? rec.designatedArea
              .replace(/\s*\(City and Borough\)\s*/gi, '')
              .replace(/\s*\(County\)\s*/gi, '')
              .replace(/\s*\(Parish\)\s*/gi, '')
              .replace(/\s*\(Borough\)\s*/gi, '')
              .replace(/\s*\(Census Area\)\s*/gi, '')
              .replace(/\s*\(city\)\s*/gi, '')
              .replace(/\s*\(Municipio\)\s*/gi, '')
              .replace(/\s*\(ANV\/ANVSA\)\s*/gi, '')
              .trim()
          : null;
        if (county && !groups[key].counties.includes(county)) {
          groups[key].counties.push(county);
        }
      }

      const disasters = [];
      for (const key of Object.keys(groups)) {
        const g = groups[key];
        if (!g.declarationDate || !g.incidentBeginDate) continue;

        const sepStartDate = calculateSEPStart(g.declarationDate, g.incidentBeginDate);
        const sepStartStr = toISODate(sepStartDate);
        const isOngoing = !g.incidentEndDate;

        let sepEndDate;
        if (isOngoing) {
          sepEndDate = calculateOngoingMaxEnd(sepStartStr, null);
        } else {
          sepEndDate = calculateSEPWindowEnd(g.incidentEndDate);
        }

        const status = calculateStatus(sepEndDate, isOngoing);
        if (status === 'expired') continue;

        const declDate = new Date(g.declarationDate + 'T00:00:00');
        if (declDate > new Date()) continue;

        if (g.incidentEndDate) {
          const incStart = new Date(g.incidentBeginDate + 'T00:00:00');
          const incEnd = new Date(g.incidentEndDate + 'T00:00:00');
          if (incStart > incEnd) continue;
        }

        const daysRem = getDaysRemaining(sepEndDate);
        const isStatewide = g.counties.some(c => c.toLowerCase() === 'statewide');

        disasters.push({
          id: `FEMA-${g.femaDeclarationString}`,
          source: 'FEMA',
          state: g.state,
          title: g.declarationTitle,
          incidentType: g.incidentType,
          declarationDate: g.declarationDate,
          incidentStart: g.incidentBeginDate,
          incidentEnd: g.incidentEndDate,
          renewalDates: null,
          counties: g.counties.sort(),
          statewide: isStatewide,
          officialUrl: `https://www.fema.gov/disaster/${g.disasterNumber}`,
          status: status,
          sepWindowStart: sepStartStr,
          sepWindowEnd: toISODate(sepEndDate),
          daysRemaining: daysRem,
          confidenceLevel: 'verified',
          lastUpdated: new Date().toISOString(),
          declarationId: g.femaDeclarationString,
        });
      }

      return disasters;
    }

    // =========================================================================
    // County name normalization for search matching
    // =========================================================================

    function normalizeCountyName(name) {
      return name
        .toLowerCase()
        .replace(/\s*\(county\)\s*/g, '')
        .replace(/\s*\(parish\)\s*/g, '')
        .replace(/\s*\(borough\)\s*/g, '')
        .replace(/\s*\(census area\)\s*/g, '')
        .replace(/\s*\(city and borough\)\s*/g, '')
        .replace(/\s*\(city\)\s*/g, '')
        .replace(/\s*\(municipio\)\s*/g, '')
        .replace(/\bsaint\b/g, 'st')
        .replace(/\bst\.\s*/g, 'st ')
        .replace(/\bfort\b/g, 'ft')
        .replace(/\bft\.\s*/g, 'ft ')
        .replace(/\bmount\b/g, 'mt')
        .replace(/\bmt\.\s*/g, 'mt ')
        .replace(/[''`\u2018\u2019]/g, '')  // Remove apostrophes/quotes
        .replace(/[^a-z0-9\s-]/g, '')
        .trim();
    }

    function countyMatches(disasterCounties, searchCounty, isStatewide) {
      if (isStatewide) return true;
      const normalizedSearch = normalizeCountyName(searchCounty);
      return disasterCounties.some(c => {
        const normalizedC = normalizeCountyName(c);
        return normalizedC === normalizedSearch
          || normalizedC.includes(normalizedSearch)
          || normalizedSearch.includes(normalizedC);
      });
    }

    // =========================================================================
    // Title formatting — FEMA titles are ALL CAPS, normalize to Title Case
    // =========================================================================

    function formatTitle(title) {
      if (!title) return '';
      // Only transform if the title is mostly uppercase (FEMA style)
      const uppercaseRatio = (title.replace(/[^A-Z]/g, '').length) / (title.replace(/[^A-Za-z]/g, '').length || 1);
      if (uppercaseRatio < 0.7) return title; // Already mixed case, leave it
      const smallWords = new Set(['a','an','the','and','but','or','for','nor','on','at','to','by','in','of','up','as']);
      return title.toLowerCase().replace(/\b\w+/g, (word, index) => {
        if (index > 0 && smallWords.has(word)) return word;
        return word.charAt(0).toUpperCase() + word.slice(1);
      });
    }

    // =========================================================================
    // Medicare beneficiary count helpers
    // =========================================================================

    function formatBeneficiaryCount(num) {
      if (!num || num <= 0) return null;
      if (num >= 1000000) return `~${(num / 1000000).toFixed(1)}M`;
      if (num >= 1000) return `~${Math.round(num / 1000).toLocaleString()}K`;
      return `~${num.toLocaleString()}`;
    }

    function getDisasterBeneficiaries(disaster, enrollmentData) {
      if (!enrollmentData || !enrollmentData.states) return null;
      const stateData = enrollmentData.states[disaster.state];
      if (!stateData) return null;

      if (disaster.statewide) {
        return stateData.total;
      }

      if (!disaster.counties || !Array.isArray(disaster.counties)) return null;

      // Build normalized lookup for fuzzy matching (handles DeSoto vs De Soto, etc.)
      const normalizedLookup = {};
      for (const [name, data] of Object.entries(stateData.counties)) {
        normalizedLookup[name.toLowerCase().replace(/\s+/g, '')] = data;
      }

      let total = 0;
      let matchedCounties = 0;
      for (const county of disaster.counties) {
        if (county === 'Statewide') return stateData.total;
        // Try exact match first, then normalized
        const countyData = stateData.counties[county]
          || normalizedLookup[county.toLowerCase().replace(/\s+/g, '')];
        if (countyData) {
          total += countyData.total;
          matchedCounties++;
        }
      }
      return matchedCounties > 0 ? total : null;
    }

    function getStateBeneficiaries(stateCode, enrollmentData) {
      if (!enrollmentData || !enrollmentData.states) return null;
      const stateData = enrollmentData.states[stateCode];
      return stateData ? stateData.total : null;
    }

    // =========================================================================
    // Copy to clipboard — SunFire format
    // =========================================================================

    function buildCopyText(disaster) {
      const title = disaster.title;
      const sourceId = disaster.source === 'FEMA'
        ? `FEMA ${disaster.declarationId || disaster.id.replace('FEMA-', '')}`
        : disaster.id;

      const startStr = formatDateHuman(disaster.sepWindowStart);
      const endStr = disaster.status === 'ongoing' ? 'Ongoing' : (disaster.sepWindowEnd ? formatDateHuman(disaster.sepWindowEnd) : 'Ongoing');

      return [
        `DST \u2014 ${title} (${sourceId})`,
        `SEP Window: ${startStr} \u2014 ${endStr}`,
        `Official Declaration: ${disaster.officialUrl}`,
      ].join('\n');
    }

    // =========================================================================
    // React Components
    // =========================================================================

    // --- CopyButton ---
    function CopyButton({ disaster }) {
      const [copied, setCopied] = useState(false);

      const handleCopy = useCallback(async () => {
        const text = buildCopyText(disaster);
        try {
          await navigator.clipboard.writeText(text);
          setCopied(true);
          setTimeout(() => setCopied(false), 1200);
        } catch {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          setCopied(true);
          setTimeout(() => setCopied(false), 1200);
        }
      }, [disaster]);

      return (
        <div className="relative inline-block">
          <button
            onClick={handleCopy}
            className="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-semibold bg-accent hover:bg-accent-dark text-white rounded-full transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
            title="Copy DST details for SunFire"
            aria-label={`Copy details for ${disaster.title} to clipboard`}
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            Copy for SunFire
          </button>
          {copied && (
            <span className="copied-anim absolute -top-8 left-1/2 -translate-x-1/2 bg-accent text-white text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap shadow-lg">
              Copied!
            </span>
          )}
        </div>
      );
    }

    // --- StatusBadge ---
    function StatusBadge({ status, daysRemaining }) {
      const config = {
        ongoing:       { classes: 'bg-secondary/10 text-secondary border-secondary/30', label: 'ONGOING' },
        active:        { classes: 'bg-accent/10 text-accent-dark border-accent/30', label: 'ACTIVE' },
        expiring_soon: { classes: 'bg-red-50 text-red-700 border-red-300 pulse-urgent', label: 'EXPIRING SOON' },
      };
      const c = config[status] || config.active;
      return (
        <span className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-bold border ${c.classes}`}>
          {c.label}
          {status === 'expiring_soon' && daysRemaining != null && (
            <span className="text-xs font-bold">({daysRemaining}d)</span>
          )}
        </span>
      );
    }

    // --- SourceBadge ---
    function SourceBadge({ source }) {
      const sc = SOURCE_COLORS[source] || SOURCE_COLORS.FEMA;
      return (
        <span
          className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide"
          style={{ backgroundColor: sc.bg, color: sc.text }}
        >
          {sc.label}
        </span>
      );
    }

    // --- DSTCard ---
    function DSTCard({ disaster }) {
      const [showCounties, setShowCounties] = useState(false);
      const countyCount = disaster.counties.length;
      const displayCounties = disaster.statewide
        ? 'Statewide'
        : countyCount <= 5
          ? disaster.counties.join(', ')
          : null;

      const borderColor = disaster.status === 'expiring_soon'
        ? 'border-t-red-400 border-red-100'
        : disaster.status === 'ongoing'
          ? 'border-t-secondary border-light-cyan'
          : 'border-t-accent border-light-cyan';

      const stateName = STATE_NAMES[disaster.state] || disaster.state;

      return (
        <div className={`dst-card fade-in bg-white rounded-lg p-5 border border-light-cyan border-t-4 ${borderColor}`}>
          {/* Header row */}
          <div className="flex items-start justify-between gap-3 mb-3">
            <div className="flex items-center gap-2 flex-wrap">
              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-secondary/10 text-secondary border border-secondary/20">
                {disaster.state}
              </span>
              <SourceBadge source={disaster.source} />
              {disaster.statewide && (
                <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-200">
                  Statewide
                </span>
              )}
              <StatusBadge status={disaster.status} daysRemaining={disaster.daysRemaining} />
            </div>
            <CopyButton disaster={disaster} />
          </div>

          {/* Title */}
          <h3 className="text-base font-heading font-semibold text-text mb-3 leading-tight">
            {formatTitle(disaster.title)}
          </h3>

          {/* Metadata */}
          <div className="text-sm space-y-1.5 mb-3">
            <div className="flex items-center gap-2">
              <span className="font-medium text-soft-blue w-24 text-xs uppercase tracking-wide">Type</span>
              <span className="text-text">{disaster.incidentType}</span>
            </div>
            <div className="flex items-center gap-2">
              <span className="font-medium text-soft-blue w-24 text-xs uppercase tracking-wide">Declaration</span>
              <span className="text-text font-mono text-xs">{disaster.declarationId || disaster.id}</span>
            </div>
            <div className="flex items-center gap-2">
              <span className="font-medium text-soft-blue w-24 text-xs uppercase tracking-wide">SEP Window</span>
              <span className="font-semibold text-text">
                {formatDateHuman(disaster.sepWindowStart)} &mdash; {disaster.status === 'ongoing' ? 'Ongoing' : (disaster.sepWindowEnd ? formatDateHuman(disaster.sepWindowEnd) : 'Ongoing')}
              </span>
            </div>
            {disaster.daysRemaining != null && disaster.status !== 'ongoing' && (
              <div className="flex items-center gap-2">
                <span className="font-medium text-soft-blue w-24 text-xs uppercase tracking-wide">Remaining</span>
                <span className={`font-semibold ${disaster.daysRemaining <= 30 ? 'text-red-600' : disaster.daysRemaining <= 60 ? 'text-orange-600' : 'text-text'}`}>
                  {disaster.daysRemaining} days
                </span>
              </div>
            )}
            {disaster.lastVerified && (
              <div className="flex items-center gap-2">
                <span className="font-medium text-soft-blue w-24 text-xs uppercase tracking-wide">Verified</span>
                <span className="text-xs text-soft-blue">{formatDateHuman(disaster.lastVerified)}</span>
              </div>
            )}
          </div>

          {/* Counties */}
          <div className="text-sm mb-3">
            <span className="font-medium text-soft-blue text-xs uppercase tracking-wide">Counties: </span>
            {displayCounties ? (
              <span className="text-text">{displayCounties}</span>
            ) : (
              <>
                <button
                  onClick={() => setShowCounties(!showCounties)}
                  className="text-accent hover:text-accent-dark underline text-sm cursor-pointer"
                >
                  {showCounties ? 'Hide' : `Show ${countyCount} counties`}
                </button>
                {showCounties && (
                  <div className="mt-1 text-xs text-mid-blue leading-relaxed bg-light-cyan/50 rounded-lg p-2">
                    {disaster.counties.join(', ')}
                  </div>
                )}
              </>
            )}
          </div>

          {/* Official Link */}
          <a
            href={disaster.officialUrl}
            target="_blank"
            rel="noopener noreferrer"
            className="inline-flex items-center gap-1.5 text-sm text-accent hover:text-accent-dark font-semibold hover:underline focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 rounded"
            aria-label={`View official declaration for ${disaster.title}`}
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            Official Declaration
          </a>
        </div>
      );
    }

    // --- StateSection ---
    function StateSection({ stateCode, disasters, enrollmentData }) {
      const [collapsed, setCollapsed] = useState(false);
      const stateName = STATE_NAMES[stateCode] || stateCode;
      const sourceBreakdown = useMemo(() => {
        const counts = {};
        for (const d of disasters) { counts[d.source] = (counts[d.source] || 0) + 1; }
        return counts;
      }, [disasters]);

      const beneficiaryCount = getStateBeneficiaries(stateCode, enrollmentData);

      return (
        <div className="mb-6">
          <button
            onClick={() => setCollapsed(!collapsed)}
            className="flex items-center gap-3 w-full text-left py-3 px-4 bg-white hover:bg-light-cyan/30 rounded-lg transition-colors border border-light-cyan cursor-pointer"
          >
            <svg className={`w-4 h-4 text-secondary transition-transform ${collapsed ? '' : 'rotate-90'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
            <h2 className="text-base font-heading font-bold text-text">{stateName}</h2>
            <span className="text-xs font-semibold text-mid-blue bg-light-cyan px-2.5 py-0.5 rounded-full">
              {disasters.length} {disasters.length === 1 ? 'DST' : 'DSTs'}
            </span>
            {beneficiaryCount && (
              <span className="text-xs text-soft-blue font-body" title="Total Medicare beneficiaries in this state (CMS data)">
                {formatBeneficiaryCount(beneficiaryCount)} Medicare
              </span>
            )}
            <div className="flex items-center gap-1 ml-auto">
              {Object.entries(sourceBreakdown).map(([src, count]) => {
                const sc = SOURCE_COLORS[src] || SOURCE_COLORS.FEMA;
                return (
                  <span key={src} className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold" style={{ backgroundColor: sc.bg + '18', color: sc.bg }}>
                    {count} {sc.label}
                  </span>
                );
              })}
            </div>
          </button>
          {!collapsed && (
            <div className="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-3">
              {disasters.map(d => <DSTCard key={d.id} disaster={d} />)}
            </div>
          )}
        </div>
      );
    }

    // --- CountyAutocomplete ---
    // Supports both state-scoped and cross-state county search
    function CountyAutocomplete({ countyMap, selectedState, value, onChange, onStateSelect }) {
      const [isFocused, setIsFocused] = useState(false);
      const [highlightIndex, setHighlightIndex] = useState(-1);
      const inputRef = useRef(null);
      const listRef = useRef(null);

      const suggestions = useMemo(() => {
        if (!value || value.length < 2) return [];
        const normalizedInput = normalizeCountyName(value);

        if (selectedState) {
          // State selected — only show counties in that state
          const counties = countyMap[selectedState] || [];
          return counties
            .filter(c => normalizeCountyName(c).includes(normalizedInput))
            .map(c => ({ county: c, state: selectedState }))
            .slice(0, 20);
        } else {
          // No state selected — search across ALL states (~3,200 counties, fast)
          const results = [];
          for (const [stateCode, counties] of Object.entries(countyMap)) {
            for (const c of counties) {
              if (normalizeCountyName(c).includes(normalizedInput)) {
                results.push({ county: c, state: stateCode });
              }
            }
          }
          // Sort: exact matches first, then alphabetical by county then state
          results.sort((a, b) => {
            const aExact = normalizeCountyName(a.county) === normalizedInput ? 0 : 1;
            const bExact = normalizeCountyName(b.county) === normalizedInput ? 0 : 1;
            if (aExact !== bExact) return aExact - bExact;
            const countyComp = a.county.localeCompare(b.county);
            if (countyComp !== 0) return countyComp;
            return a.state.localeCompare(b.state);
          });
          return results.slice(0, 20);
        }
      }, [countyMap, selectedState, value]);

      const showSuggestions = isFocused && suggestions.length > 0 && value.length >= 2;

      const handleSelect = useCallback((item) => {
        onChange(item.county);
        // If no state was selected, auto-select the state for this county
        if (!selectedState && onStateSelect) {
          onStateSelect(item.state);
        }
        setIsFocused(false);
        setHighlightIndex(-1);
      }, [onChange, onStateSelect, selectedState]);

      const handleKeyDown = useCallback((e) => {
        if (!showSuggestions) return;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          setHighlightIndex(prev => Math.min(prev + 1, suggestions.length - 1));
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          setHighlightIndex(prev => Math.max(prev - 1, 0));
        } else if (e.key === 'Enter' && highlightIndex >= 0) {
          e.preventDefault();
          handleSelect(suggestions[highlightIndex]);
        } else if (e.key === 'Escape') {
          setIsFocused(false);
        }
      }, [showSuggestions, suggestions, highlightIndex, handleSelect]);

      return (
        <div className="relative">
          <input
            ref={inputRef}
            type="text"
            value={value}
            onChange={(e) => { onChange(e.target.value); setHighlightIndex(-1); }}
            onFocus={() => setIsFocused(true)}
            onBlur={() => setTimeout(() => setIsFocused(false), 200)}
            onKeyDown={handleKeyDown}
            placeholder={selectedState ? "Type county name..." : "Search any county..."}
            className="w-full px-3 py-2 border border-light-cyan rounded-lg focus:ring-2 focus:ring-accent focus:border-accent text-sm font-body"
            aria-label="County search"
          />
          {showSuggestions && (
            <ul ref={listRef} className="autocomplete-list absolute z-50 w-full mt-1 bg-white border border-light-cyan rounded-lg shadow-lg">
              {suggestions.map((item, idx) => (
                <li
                  key={`${item.state}-${item.county}`}
                  onMouseDown={() => handleSelect(item)}
                  className={`autocomplete-item px-3 py-2 text-sm cursor-pointer flex items-center justify-between ${idx === highlightIndex ? 'bg-accent/10 text-accent-dark font-medium' : 'text-text'}`}
                >
                  <span>{item.county}</span>
                  {!selectedState && (
                    <span className="text-xs text-mid-blue bg-light-cyan px-1.5 py-0.5 rounded ml-2 flex-shrink-0">
                      {item.state}
                    </span>
                  )}
                </li>
              ))}
            </ul>
          )}
        </div>
      );
    }

    // --- SortSelector ---
    function SortSelector({ value, onChange }) {
      return (
        <div className="flex items-center gap-2 text-sm">
          <label className="font-medium text-mid-blue">Sort:</label>
          <select
            value={value}
            onChange={(e) => onChange(e.target.value)}
            className="border border-light-cyan rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-accent focus:border-accent bg-white font-body"
          >
            <option value="state">By State (A-Z)</option>
            <option value="recent">Most Recent First</option>
            <option value="ending">Ending Soonest</option>
          </select>
        </div>
      );
    }

    // =========================================================================
    // Main App
    // =========================================================================

    // --- DebugPanel ---
    function DebugPanel({ debugInfo, onClose }) {
      if (!debugInfo) return null;
      const { fema, curated, filtered, lastLoad } = debugInfo;
      const statusIcon = (ok) => ok ? '\u2713' : '\u2717';
      return (
        <div style={{
          position: 'fixed', bottom: 12, right: 12, zIndex: 10000,
          background: 'rgba(16,32,44,0.95)', color: '#3DCEB2',
          fontFamily: 'ui-monospace, monospace', fontSize: 12,
          padding: '14px 16px', borderRadius: 8, maxWidth: 360,
          maxHeight: '50vh', overflowY: 'auto', lineHeight: 1.6,
          boxShadow: '0 4px 24px rgba(0,0,0,0.5)',
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
            <strong style={{ color: '#3DCEB2' }}>DEBUG PANEL</strong>
            <button onClick={onClose} style={{ background: 'none', border: 'none', color: '#3DCEB2', cursor: 'pointer', fontSize: 14 }}>{'\u2715'}</button>
          </div>
          <div style={{ marginBottom: 8 }}>
            <div style={{ color: '#A7B8C5' }}>FEMA Fetch</div>
            <div>Status: {statusIcon(fema.status === 'success')} {fema.status}</div>
            <div>Raw API records: {fema.rawCount}</div>
            <div>After consolidation: {fema.consolidatedCount}</div>
            <div>Fetch time: {fema.timeMs}ms</div>
          </div>
          <div style={{ marginBottom: 8 }}>
            <div style={{ color: '#A7B8C5' }}>Curated JSON</div>
            <div>Status: {statusIcon(curated.status === 'success')} {curated.status}</div>
            <div>Records loaded: {curated.count}</div>
            <div>Sources: {curated.sources || 'none'}</div>
          </div>
          <div style={{ marginBottom: 8 }}>
            <div style={{ color: '#A7B8C5' }}>Filtering</div>
            <div>Expired removed: {filtered.expired}</div>
            <div>Invalid removed: {filtered.invalid}</div>
            <div>Duplicates removed: {filtered.duplicates}</div>
            <div>Final display: {filtered.finalCount}</div>
          </div>
          <div style={{ color: '#4B7797', fontSize: 10, marginTop: 8 }}>
            Last load: {lastLoad || 'N/A'}
          </div>
        </div>
      );
    }

    // --- Staleness Banner ---
    function StalenessBanner({ curatedLastUpdated, curatedIntegrity }) {
      if (!curatedLastUpdated) return null;
      const now = new Date();
      const diffDays = Math.floor((now - curatedLastUpdated) / (1000 * 60 * 60 * 24));
      const urlFailCount = curatedIntegrity?.urlVerification?.failCount || 0;
      const regChanged = curatedIntegrity?.regulatoryMonitoring?.regulationChanged === true;

      // Show banner if stale OR if URL issues exist OR if regulation changed
      if (diffDays <= STALENESS_DAYS && urlFailCount === 0 && !regChanged) return null;

      return (
        <div className={`${regChanged ? 'bg-red-50 border-red-200' : 'bg-amber-50 border-amber-200'} border-b px-4 py-2.5`}>
          <div className="max-w-7xl mx-auto flex flex-col gap-1 text-sm">
            {regChanged && (
              <div className="flex items-center gap-2 text-red-800">
                <svg className="w-5 h-5 flex-shrink-0 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <span className="font-body">
                  <strong>⚠ Regulatory change detected.</strong> 42 CFR § 422.62 has been amended.
                  SEP window calculations may need updating. Contact compliance before relying on dates shown.
                </span>
              </div>
            )}
            {diffDays > STALENESS_DAYS && (
              <div className="flex items-center gap-2 text-amber-800">
                <svg className="w-5 h-5 flex-shrink-0 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span className="font-body">
                  <strong>Data may be outdated.</strong> Curated disaster data was last updated <strong>{diffDays} days ago</strong>
                  {' '}({curatedLastUpdated.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}).
                  Verify current declarations before enrollment.
                </span>
              </div>
            )}
            {urlFailCount > 0 && (
              <div className="flex items-center gap-2 text-amber-800">
                <svg className="w-5 h-5 flex-shrink-0 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
                <span className="font-body">
                  <strong>{urlFailCount} declaration link{urlFailCount > 1 ? 's' : ''}</strong> may need verification.
                  Some official URLs may have changed.
                </span>
              </div>
            )}
          </div>
        </div>
      );
    }

    function App() {
      // Data state
      const [femaDisasters, setFemaDisasters] = useState([]);
      const [curatedDisasters, setCuratedDisasters] = useState([]);
      const [countyMap, setCountyMap] = useState({});
      const [loading, setLoading] = useState(true);
      const [femaError, setFemaError] = useState(null);
      const [curatedError, setCuratedError] = useState(null);
      const [lastFemaFetch, setLastFemaFetch] = useState(null);
      const [curatedLastUpdated, setCuratedLastUpdated] = useState(null);
      const [curatedIntegrity, setCuratedIntegrity] = useState(null);
      const [enrollmentData, setEnrollmentData] = useState(null);

      // Search state
      const [selectedState, setSelectedState] = useState('');
      const [countyInput, setCountyInput] = useState('');
      const [sortMode, setSortMode] = useState('state');

      // Source filter state
      const [sourceFilter, setSourceFilter] = useState('all');

      // Debug state
      const [showDebug, setShowDebug] = useState(false);
      const [debugInfo, setDebugInfo] = useState(null);

      // Keyboard shortcut: Ctrl+Shift+D toggles debug panel
      useEffect(() => {
        const handler = (e) => {
          if (e.ctrlKey && e.shiftKey && (e.key === 'D' || e.key === 'd')) {
            e.preventDefault();
            setShowDebug(prev => !prev);
          }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
      }, []);

      // Load data on mount
      useEffect(() => {
        loadData();
      }, []);

      async function loadData() {
        setLoading(true);
        const debug = {
          fema: { status: 'pending', rawCount: 0, consolidatedCount: 0, timeMs: 0 },
          curated: { status: 'pending', count: 0, sources: '' },
          filtered: { expired: 0, invalid: 0, duplicates: 0, finalCount: 0 },
          lastLoad: null,
        };

        const countyPromise = fetch('county_state_map.json')
          .then(r => r.ok ? r.json() : {})
          .catch(() => ({}));

        const enrollmentPromise = fetch('medicare_enrollment.json')
          .then(r => r.ok ? r.json() : null)
          .catch(() => null);

        const curatedPromise = fetch('curated_disasters.json')
          .then(r => {
            if (!r.ok) { debug.curated.status = 'error (' + r.status + ')'; setCuratedError('Failed to load curated disaster data (HTTP ' + r.status + ')'); return []; }
            return r.json();
          })
          .then(data => {
            if (data && !Array.isArray(data) && data.disasters) {
              if (data.metadata) {
                if (data.metadata.lastUpdated) {
                  setCuratedLastUpdated(new Date(data.metadata.lastUpdated));
                }
                if (data.metadata.dataIntegrity) {
                  setCuratedIntegrity(data.metadata.dataIntegrity);
                }
              }
              setCuratedError(null);
              return data.disasters;
            }
            setCuratedError(null);
            return Array.isArray(data) ? data : [];
          })
          .catch((err) => { debug.curated.status = 'error'; setCuratedError('Failed to load curated disaster data'); return []; });

        let femaData = [];
        let femaErr = null;
        const femaStart = performance.now();
        try {
          const rawFema = await fetchAllFEMA();
          debug.fema.rawCount = rawFema.length;
          femaData = consolidateFEMA(rawFema);
          debug.fema.consolidatedCount = femaData.length;
          debug.fema.status = 'success';
          debug.fema.timeMs = Math.round(performance.now() - femaStart);
          setLastFemaFetch(new Date());
        } catch (err) {
          femaErr = err.message;
          debug.fema.status = 'error: ' + err.message;
          debug.fema.timeMs = Math.round(performance.now() - femaStart);
          console.error('FEMA API error:', err);
        }

        const [countyData, curatedData, enrollData] = await Promise.all([countyPromise, curatedPromise, enrollmentPromise]);

        if (debug.curated.status === 'pending') {
          debug.curated.status = curatedData.length > 0 ? 'success' : 'empty';
        }
        debug.curated.count = curatedData.length;
        if (curatedData.length > 0) {
          const srcSet = new Set(curatedData.map(d => d.source).filter(Boolean));
          debug.curated.sources = [...srcSet].join(', ') || 'none';
        }

        debug.lastLoad = new Date().toLocaleString();
        setDebugInfo(debug);

        setFemaDisasters(femaData);
        setFemaError(femaErr);
        setCuratedDisasters(curatedData);
        setCountyMap(countyData);
        setEnrollmentData(enrollData);
        setLoading(false);
      }

      // Merge and deduplicate disasters
      const allDisastersData = useMemo(() => {
        const byId = {};
        let dbgExpired = 0, dbgInvalid = 0, dbgDuplicates = 0;

        for (const d of femaDisasters) {
          byId[d.id] = d;
        }

        for (const d of curatedDisasters) {
          try {
            if (d.source === 'FEMA') { dbgInvalid++; continue; }
            if (!d.id || !d.declarationDate || !d.incidentStart) { dbgInvalid++; continue; }

            const sepStartDate = calculateSEPStart(d.declarationDate, d.incidentStart);
            const sepStartStr = toISODate(sepStartDate);
            const isOngoing = !d.incidentEnd;

            let sepEndDate;
            if (isOngoing) {
              sepEndDate = calculateOngoingMaxEnd(sepStartStr, d.renewalDates || null);
            } else {
              sepEndDate = calculateSEPWindowEnd(d.incidentEnd);
            }

            if (!sepEndDate || isNaN(sepEndDate.getTime())) { dbgInvalid++; continue; }

            const status = calculateStatus(sepEndDate, isOngoing);
            if (status === 'expired') { dbgExpired++; continue; }

            const daysRem = getDaysRemaining(sepEndDate);

            const declDate = new Date(d.declarationDate + 'T00:00:00');
            if (isNaN(declDate.getTime()) || declDate > new Date()) { dbgInvalid++; continue; }
            if (d.incidentEnd) {
              const incStart = new Date(d.incidentStart + 'T00:00:00');
              const incEnd = new Date(d.incidentEnd + 'T00:00:00');
              if (isNaN(incStart.getTime()) || isNaN(incEnd.getTime()) || incStart > incEnd) { dbgInvalid++; continue; }
            }
            if (!d.officialUrl) { dbgInvalid++; continue; }
            if (!d.counties || !Array.isArray(d.counties) || d.counties.length === 0) { dbgInvalid++; continue; }

            if (!byId[d.id]) {
              byId[d.id] = {
                ...d,
                status,
                sepWindowStart: sepStartStr,
                sepWindowEnd: toISODate(sepEndDate),
                daysRemaining: daysRem,
              };
            } else {
              dbgDuplicates++;
            }
          } catch (err) {
            console.warn('Skipping malformed curated entry:', d?.id || 'UNKNOWN', err);
            dbgInvalid++;
          }
        }

        const result = Object.values(byId);

        return { disasters: result, dbgExpired, dbgInvalid, dbgDuplicates };
      }, [femaDisasters, curatedDisasters]);

      const allDisasters = allDisastersData.disasters;

      useEffect(() => {
        if (debugInfo) {
          const { dbgExpired, dbgInvalid, dbgDuplicates, disasters } = allDisastersData;
          setDebugInfo(prev => prev ? {
            ...prev,
            filtered: { expired: dbgExpired, invalid: dbgInvalid, duplicates: dbgDuplicates, finalCount: disasters.length }
          } : prev);
        }
      }, [allDisastersData]);

      // Get unique sources for filter
      const availableSources = useMemo(() => {
        const srcSet = new Set(allDisasters.map(d => d.source));
        return [...srcSet].sort();
      }, [allDisasters]);

      // Filter by search + source
      const filteredDisasters = useMemo(() => {
        let results = allDisasters;

        if (selectedState) {
          results = results.filter(d => d.state === selectedState);
        }

        if (countyInput && countyInput.length >= 2) {
          if (selectedState) {
            // State is selected — use normal county matching (statewide = match)
            results = results.filter(d =>
              countyMatches(d.counties, countyInput, d.statewide)
            );
          } else {
            // No state selected — cross-state county search
            // For statewide disasters, only include if the county exists in that state
            results = results.filter(d => {
              if (d.statewide) {
                // Check if the typed county exists in this disaster's state
                const stateCounties = countyMap[d.state] || [];
                return stateCounties.some(c => normalizeCountyName(c).includes(normalizeCountyName(countyInput)));
              }
              return countyMatches(d.counties, countyInput, false);
            });
          }
        }

        if (sourceFilter !== 'all') {
          results = results.filter(d => d.source === sourceFilter);
        }

        return results;
      }, [allDisasters, selectedState, countyInput, sourceFilter, countyMap]);

      // Sort
      const sortedDisasters = useMemo(() => {
        const sorted = [...filteredDisasters];
        if (sortMode === 'state') {
          sorted.sort((a, b) => {
            const stateComp = a.state.localeCompare(b.state);
            if (stateComp !== 0) return stateComp;
            return (b.declarationDate || '').localeCompare(a.declarationDate || '');
          });
        } else if (sortMode === 'recent') {
          sorted.sort((a, b) => (b.declarationDate || '').localeCompare(a.declarationDate || ''));
        } else if (sortMode === 'ending') {
          sorted.sort((a, b) => {
            if (!a.sepWindowEnd && b.sepWindowEnd) return 1;
            if (a.sepWindowEnd && !b.sepWindowEnd) return -1;
            if (!a.sepWindowEnd && !b.sepWindowEnd) return 0;
            return (a.sepWindowEnd || '').localeCompare(b.sepWindowEnd || '');
          });
        }
        return sorted;
      }, [filteredDisasters, sortMode]);

      // Group by state for state-sorted view
      const groupedByState = useMemo(() => {
        if (sortMode !== 'state') return null;
        const groups = {};
        for (const d of sortedDisasters) {
          if (!groups[d.state]) groups[d.state] = [];
          groups[d.state].push(d);
        }
        return groups;
      }, [sortedDisasters, sortMode]);

      // State dropdown options
      const stateOptions = useMemo(() => {
        const states = Object.keys(countyMap).sort();
        return states;
      }, [countyMap]);

      const handleStateChange = useCallback((e) => {
        setSelectedState(e.target.value);
        setCountyInput('');
      }, []);

      const handleClearSearch = useCallback(() => {
        setSelectedState('');
        setCountyInput('');
        setSourceFilter('all');
      }, []);

      const totalCount = allDisasters.length;
      const displayCount = sortedDisasters.length;

      // Compute total affected beneficiaries with proper deduplication:
      // - Deduplicate by state (FEMA + curated can overlap for same state)
      // - Statewide disasters: use full state enrollment total
      // - County-only states: sum unique county enrollments (not full state)
      const enrollmentSummary = useMemo(() => {
        if (!enrollmentData || !enrollmentData.states) return null;

        // Phase 1: Merge all disasters by state, track statewide vs county-level
        const stateInfo = {};
        for (const d of allDisasters) {
          if (!d.state) continue;
          if (!stateInfo[d.state]) {
            stateInfo[d.state] = { statewide: false, counties: new Set() };
          }
          if (d.statewide || (d.counties && d.counties.includes('Statewide'))) {
            stateInfo[d.state].statewide = true;
          } else if (d.counties && Array.isArray(d.counties)) {
            for (const c of d.counties) stateInfo[d.state].counties.add(c);
          }
        }

        // Phase 2: Sum beneficiaries (statewide = full total, county-only = county sum)
        let totalBeneficiaries = 0;
        for (const [stateCode, info] of Object.entries(stateInfo)) {
          const stateData = enrollmentData.states[stateCode];
          if (!stateData) continue;

          if (info.statewide) {
            totalBeneficiaries += stateData.total;
          } else {
            let countyTotal = 0;
            let matchedAny = false;
            const normalizedLookup = {};
            if (stateData.counties) {
              for (const [name, data] of Object.entries(stateData.counties)) {
                normalizedLookup[name.toLowerCase().replace(/\s+/g, '')] = data;
              }
            }
            for (const county of info.counties) {
              const countyData = stateData.counties?.[county]
                || normalizedLookup[county.toLowerCase().replace(/\s+/g, '')];
              if (countyData) {
                countyTotal += countyData.total;
                matchedAny = true;
              }
            }
            totalBeneficiaries += matchedAny ? countyTotal : stateData.total;
          }
        }

        return {
          totalBeneficiaries,
          affectedStates: Object.keys(stateInfo).length,
          period: enrollmentData.metadata?.period || 'Unknown',
        };
      }, [allDisasters, enrollmentData]);
      const sourceCounts = useMemo(() => {
        const counts = {};
        for (const d of sortedDisasters) { counts[d.source] = (counts[d.source] || 0) + 1; }
        return counts;
      }, [sortedDisasters]);

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Header */}
          <header className="bg-secondary sticky top-0 z-40 shadow-md">
            <div className="max-w-7xl mx-auto px-4 py-3.5">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-lg font-heading font-bold text-white tracking-tight">DST Compiler Tool</h1>
                  <p className="text-xs text-light-cyan/80 font-body">Disaster Special Enrollment Period Lookup</p>
                </div>
                <div className="flex items-center gap-4">
                  <div className="text-right text-xs font-body">
                    {lastFemaFetch && (
                      <div className="text-light-cyan/70">FEMA data: {lastFemaFetch.toLocaleTimeString()}</div>
                    )}
                    {curatedLastUpdated && (
                      <div className="text-light-cyan/70">
                        Curated data: {curatedLastUpdated.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                        {curatedIntegrity?.urlVerification?.lastRun && (
                          curatedIntegrity.urlVerification.failCount === 0
                            ? <span className="ml-1.5 text-green-300" title={`URLs verified ${new Date(curatedIntegrity.urlVerification.lastRun).toLocaleDateString()}`}>✓ Links verified</span>
                            : <span className="ml-1.5 text-amber-300" title={`${curatedIntegrity.urlVerification.failCount} URL(s) may need attention`}>⚠ {curatedIntegrity.urlVerification.failCount} link issue{curatedIntegrity.urlVerification.failCount > 1 ? 's' : ''}</span>
                        )}
                        {curatedIntegrity?.regulatoryMonitoring?.status && (
                          curatedIntegrity.regulatoryMonitoring.status === "PASS"
                            ? <span className="ml-1.5 text-green-300" title={`42 CFR § 422.62 unchanged (checked ${new Date(curatedIntegrity.regulatoryMonitoring.lastChecked).toLocaleDateString()})`}>✓ Reg current</span>
                            : curatedIntegrity.regulatoryMonitoring.status === "FAIL"
                              ? <span className="ml-1.5 text-red-300 font-bold" title="42 CFR § 422.62 has been amended — SEP calculations may need updating">⚠ REG CHANGED</span>
                              : <span className="ml-1.5 text-amber-300" title="Could not verify regulatory status">? Reg unknown</span>
                        )}
                      </div>
                    )}
                  </div>
                  <div className="bg-accent text-white text-sm font-heading font-bold px-4 py-1.5 rounded-full">
                    {totalCount} DSTs
                  </div>
                </div>
              </div>
            </div>
          </header>

          {/* Staleness Banner */}
          <StalenessBanner curatedLastUpdated={curatedLastUpdated} curatedIntegrity={curatedIntegrity} />

          {/* FEMA Error Banner */}
          {femaError && (
            <div className="bg-amber-50 border-b border-amber-200 px-4 py-2.5">
              <div className="max-w-7xl mx-auto flex items-center gap-2 text-sm text-amber-800 font-body">
                <svg className="w-5 h-5 flex-shrink-0 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <span>
                  FEMA data unavailable &mdash; showing non-FEMA sources only. <button onClick={loadData} className="underline font-semibold hover:text-amber-900 cursor-pointer">Refresh to retry.</button>
                </span>
              </div>
            </div>
          )}

          {/* Curated Data Error Banner */}
          {curatedError && (
            <div className="bg-red-50 border-b border-red-200 px-4 py-2.5">
              <div className="max-w-7xl mx-auto flex items-center gap-2 text-sm text-red-800 font-body">
                <svg className="w-5 h-5 flex-shrink-0 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <span>
                  Some disaster data temporarily unavailable &mdash; showing FEMA data only. SBA, FMCSA, and governor declarations may be missing.
                  <button onClick={loadData} className="underline font-semibold hover:text-red-900 ml-1 cursor-pointer">Refresh to retry.</button>
                </span>
              </div>
            </div>
          )}

          {/* Search Bar */}
          <div className="bg-white border-b border-light-cyan">
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex flex-col sm:flex-row gap-3 items-end">
                {/* State Select */}
                <div className="w-full sm:w-56">
                  <label className="block text-xs font-semibold text-mid-blue mb-1 font-heading">State</label>
                  <select
                    value={selectedState}
                    onChange={handleStateChange}
                    className="w-full px-3 py-2 border border-light-cyan rounded-lg focus:ring-2 focus:ring-accent focus:border-accent text-sm bg-white font-body"
                  >
                    <option value="">All States</option>
                    {stateOptions.map(code => (
                      <option key={code} value={code}>
                        {STATE_NAMES[code] || code} ({code})
                      </option>
                    ))}
                  </select>
                </div>

                {/* County Autocomplete */}
                <div className="w-full sm:w-64">
                  <label className="block text-xs font-semibold text-mid-blue mb-1 font-heading">County</label>
                  <CountyAutocomplete
                    countyMap={countyMap}
                    selectedState={selectedState}
                    value={countyInput}
                    onChange={setCountyInput}
                    onStateSelect={setSelectedState}
                  />
                </div>

                {/* Source Filter */}
                <div className="w-full sm:w-40">
                  <label className="block text-xs font-semibold text-mid-blue mb-1 font-heading">Source</label>
                  <select
                    value={sourceFilter}
                    onChange={(e) => setSourceFilter(e.target.value)}
                    className="w-full px-3 py-2 border border-light-cyan rounded-lg focus:ring-2 focus:ring-accent focus:border-accent text-sm bg-white font-body"
                  >
                    <option value="all">All Sources</option>
                    {availableSources.map(src => (
                      <option key={src} value={src}>{SOURCE_COLORS[src]?.label || src}</option>
                    ))}
                  </select>
                </div>

                {/* Sort */}
                <div className="w-full sm:w-auto">
                  <SortSelector value={sortMode} onChange={setSortMode} />
                </div>

                {/* Clear */}
                {(selectedState || countyInput || sourceFilter !== 'all') && (
                  <button
                    onClick={handleClearSearch}
                    className="text-sm text-mid-blue hover:text-secondary underline whitespace-nowrap pb-2 cursor-pointer font-body"
                  >
                    Clear filters
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* Compliance Attestation Banner */}
          <div className="bg-deep-navy/95 border-b border-secondary/40">
            <div className="max-w-7xl mx-auto px-4 py-3.5">
              <div className="flex items-start gap-3">
                <svg className="w-5 h-5 text-accent flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-1.5">
                    <h4 className="text-sm font-heading font-bold text-white">DST Three-Part Validation Required</h4>
                    <span className="text-xs text-accent/70 font-body">&mdash; 42 CFR &sect; 422.62(b)(18)</span>
                  </div>
                  <div className="flex flex-col sm:flex-row sm:items-start gap-x-6 gap-y-1 text-sm text-light-cyan/80 font-body">
                    <span><strong className="text-white">1.</strong> Client resides in declared disaster area</span>
                    <span><strong className="text-white">2.</strong> Client was eligible for another enrollment period</span>
                    <span><strong className="text-white">3.</strong> Client missed enrollment due to disaster</span>
                  </div>
                  <p className="mt-1.5 text-xs text-accent/80 font-semibold font-body">
                    No signature required &mdash; document verbal attestation in enrollment notes.
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* Main Content */}
          <main className="max-w-7xl mx-auto px-4 py-6">
            {loading ? (
              <div className="flex flex-col items-center justify-center py-20 gap-4">
                <div className="animate-spin rounded-full h-10 w-10 border-4 border-light-cyan border-t-accent"></div>
                <p className="text-sm text-mid-blue font-body">Loading disaster data...</p>
              </div>
            ) : sortedDisasters.length === 0 ? (
              <div className="text-center py-16">
                <svg className="mx-auto w-16 h-16 text-light-cyan mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 className="text-lg font-heading font-semibold text-text mb-1">No active DSTs found</h3>
                {selectedState && countyInput ? (
                  <p className="text-sm text-mid-blue font-body">
                    No active DSTs found for {countyInput}, {STATE_NAMES[selectedState] || selectedState}
                  </p>
                ) : selectedState ? (
                  <p className="text-sm text-mid-blue font-body">
                    No active DSTs found for {STATE_NAMES[selectedState] || selectedState}
                  </p>
                ) : (
                  <p className="text-sm text-mid-blue font-body">Try adjusting your search filters.</p>
                )}
              </div>
            ) : (
              <>
                {/* Impact Summary Banner */}
                {enrollmentSummary && !selectedState && sourceFilter === 'all' && !countyInput && (
                  <div className="mb-4 bg-secondary/5 rounded-lg border border-secondary/15 px-4 py-3">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-6 text-sm font-body">
                        <div>
                          <span className="text-mid-blue">Active DSTs: </span>
                          <span className="font-semibold text-text">{totalCount}</span>
                        </div>
                        <div>
                          <span className="text-mid-blue">States Affected: </span>
                          <span className="font-semibold text-text">{enrollmentSummary.affectedStates}</span>
                        </div>
                        <div>
                          <span className="text-mid-blue">Medicare Beneficiaries in Affected Areas: </span>
                          <span className="font-semibold text-text">{formatBeneficiaryCount(enrollmentSummary.totalBeneficiaries)}</span>
                        </div>
                      </div>
                      <span className="text-xs text-soft-blue font-body" title="Source: CMS Medicare Monthly Enrollment">
                        CMS data {enrollmentSummary.period}
                      </span>
                    </div>
                  </div>
                )}

                {/* Results count */}
                <div className="flex items-center justify-between mb-4 bg-white rounded-lg border border-light-cyan px-4 py-2.5">
                  <p className="text-sm text-mid-blue font-body">
                    Showing <span className="font-semibold text-text">{displayCount}</span> active {displayCount === 1 ? 'DST' : 'DSTs'}
                    {selectedState && ` in ${STATE_NAMES[selectedState] || selectedState}`}
                    {countyInput && ` matching "${countyInput}"`}
                    {sourceFilter !== 'all' && ` from ${SOURCE_COLORS[sourceFilter]?.label || sourceFilter}`}
                  </p>
                  <div className="flex items-center gap-2">
                    {Object.entries(sourceCounts).sort((a,b) => b[1] - a[1]).map(([src, count]) => {
                      const sc = SOURCE_COLORS[src] || SOURCE_COLORS.FEMA;
                      return (
                        <span key={src} className="inline-flex items-center gap-1 text-xs font-medium" style={{ color: sc.bg }}>
                          <span className="w-2 h-2 rounded-full" style={{ backgroundColor: sc.bg }}></span>
                          {count} {sc.label}
                        </span>
                      );
                    })}
                  </div>
                </div>

                {/* State-grouped view */}
                {sortMode === 'state' && groupedByState ? (
                  Object.keys(groupedByState).sort().map(stateCode => (
                    <StateSection
                      key={stateCode}
                      stateCode={stateCode}
                      disasters={groupedByState[stateCode]}
                      enrollmentData={enrollmentData}
                    />
                  ))
                ) : (
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    {sortedDisasters.map(d => (
                      <DSTCard key={d.id} disaster={d} />
                    ))}
                  </div>
                )}
              </>
            )}
          </main>

          {/* Footer */}
          <footer className="bg-deep-navy mt-8">
            <div className="max-w-7xl mx-auto px-4 py-5">
              <p className="text-center text-xs text-soft-blue/60 font-body">
                DST Compiler Tool &mdash; 42 CFR &sect; 422.62(b)(18) &mdash; For internal agent use only &mdash; Clear Path Coverage
              </p>
            </div>
          </footer>

          {/* Debug Panel */}
          {showDebug && debugInfo && (
            <DebugPanel debugInfo={debugInfo} onClose={() => setShowDebug(false)} />
          )}
        </div>
      );
    }

    // =========================================================================
    // Mount
    // =========================================================================

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
