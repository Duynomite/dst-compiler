name: Update DST Data

on:
  schedule:
    - cron: '0 11 * * *'  # 6:00 AM EST (11:00 UTC) daily
  workflow_dispatch:        # Manual trigger from Actions tab

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run data fetcher
        run: python dst_data_fetcher.py
        timeout-minutes: 10

      - name: Validate record count (prevent data loss)
        run: |
          NEW_COUNT=$(python -c "import json; d=json.load(open('curated_disasters.json')); print(len(d.get('disasters', d) if isinstance(d, dict) else d))")
          OLD_COUNT=$(git show HEAD:curated_disasters.json 2>/dev/null | python -c "import json,sys; d=json.load(sys.stdin); print(len(d.get('disasters', d) if isinstance(d, dict) else d))" 2>/dev/null || echo "0")
          echo "Previous: $OLD_COUNT records, New: $NEW_COUNT records"
          if [ "$NEW_COUNT" -lt "$OLD_COUNT" ]; then
            DROP=$((OLD_COUNT - NEW_COUNT))
            echo "::error::Record count DROPPED by $DROP (from $OLD_COUNT to $NEW_COUNT). Aborting to prevent data loss."
            echo "This likely means the Federal Register API returned fewer results than expected."
            echo "Run the fetcher locally and push manually to restore full data."
            exit 1
          fi
          echo "Record count OK: $OLD_COUNT -> $NEW_COUNT"

      - name: Commit and push if data changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git diff --quiet curated_disasters.json || (
            git add curated_disasters.json
            git commit -m "Auto-update curated disaster data"
            git push
          )

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'DST Data Fetcher Failed',
              body: `The daily data update workflow failed.\n\nSee the failed run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug']
            });
